-- ================ 核心修复：OrionLib 加载 ================
local orionLibUrl = "https://raw.githubusercontent.com/HXB20111/roblox-/refs/heads/main/gui_modified_with_toggle.txt"
local loadOrionSuccess, OrionLib = pcall(function()
    local libContent = game:HttpGet(orionLibUrl)
    return loadstring(libContent)()
end)

-- 校验 OrionLib 是否加载成功，且关键函数是否可用
if not loadOrionSuccess or type(OrionLib) ~= "table" or type(OrionLib.MakeWindow) ~= "function" then
    warn("OrionLib 加载失败或功能异常: " .. tostring(OrionLib))
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "错误",
        Text = "脚本核心库异常，功能无法使用",
        Duration = 5
    })
    return
end

-- ================ 创建主窗口 ================
local Window = OrionLib:MakeWindow({
    Name = "黄脚本",
    SaveConfig = true,
    IntroText = "黄脚本 - 功能加载完成",
    Theme = "FlatBlue",
    Icon = "rbxassetid://118894209472715"
})

-- ================ 欢迎通知（增强鲁棒性） ================
pcall(function()
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "黄脚本",
        Text = "欢迎使用，功能已就绪",
        Duration = 4,
        Icon = "rbxassetid://118894209472715"
    })
end)

-- ================ 辅助函数：远程脚本加载（终极校验） ================
local function loadRemoteScript(url, successMsg, failMsg)
    -- 1. 网络请求校验
    local httpSuccess, httpResult = pcall(game.HttpGet, game, url)
    if not httpSuccess then
        local errMsg = "网络请求失败: " .. tostring(httpResult)
        OrionLib:MakeNotification({
            Name = "加载失败",
            Content = errMsg,
            Time = 3
        })
        warn(errMsg)
        return
    end

    -- 2. 脚本加载校验
    local loadSuccess, loadFunc = pcall(loadstring, httpResult)
    if not loadSuccess then
        local errMsg = "脚本加载失败: " .. tostring(loadFunc)
        OrionLib:MakeNotification({
            Name = "加载失败",
            Content = errMsg,
            Time = 3
        })
        warn(errMsg)
        return
    end

    -- 3. 确保是函数类型
    if type(loadFunc) ~= "function" then
        local errMsg = "远程内容不是函数: " .. url
        OrionLib:MakeNotification({
            Name = "加载失败",
            Content = errMsg,
            Time = 3
        })
        warn(errMsg)
        return
    end

    -- 4. 执行脚本并捕获错误
    local executeSuccess, executeResult = pcall(loadFunc)
    if not executeSuccess then
        local errMsg = "脚本执行失败: " .. tostring(executeResult)
        OrionLib:MakeNotification({
            Name = "加载失败",
            Content = errMsg,
            Time = 3
        })
        warn(errMsg)
        return
    end

    -- 5. 加载成功通知
    OrionLib:MakeNotification({
        Name = "加载成功",
        Content = successMsg,
        Time = 3
    })
end

-- ================ 玩家功能 Tab ================
local Tab = Window:MakeTab({
    Name = "玩家功能",
    Icon = "rbxassetid://4483345998",
    PremiumOnly = false
})

-- 基础属性设置：跳跃高度（完整校验）
Tab:AddTextbox({
    Name = "跳跃高度",
    Default = "",
    TextDisappear = true,
    Callback = function(Value)
        local num = tonumber(Value)
        if not num then return end

        local localPlayer = game.Players.LocalPlayer
        local character = localPlayer.Character
        if not character then 
            OrionLib:MakeNotification({
                Name = "错误",
                Content = "角色未加载，无法设置跳跃高度",
                Time = 2
            })
            return 
        end

        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if not humanoid then 
            OrionLib:MakeNotification({
                Name = "错误",
                Content = "角色无 Humanoid，无法设置跳跃高度",
                Time = 2
            })
            return 
        end

        humanoid.JumpPower = num
    end
})

-- 基础属性设置：移动速度（完整校验）
Tab:AddTextbox({
    Name = "移动速度",
    Default = "",
    TextDisappear = true,
    Callback = function(Value)
        local num = tonumber(Value)
        if not num then return end

        local localPlayer = game.Players.LocalPlayer
        local character = localPlayer.Character
        if not character then 
            OrionLib:MakeNotification({
                Name = "错误",
                Content = "角色未加载，无法设置移动速度",
                Time = 2
            })
            return 
        end

        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if not humanoid then 
            OrionLib:MakeNotification({
                Name = "错误",
                Content = "角色无 Humanoid，无法设置移动速度",
                Time = 2
            })
            return 
        end

        humanoid.WalkSpeed = num
    end
})

-- 基础属性设置：重力
Tab:AddTextbox({
    Name = "重力",
    Default = "",
    TextDisappear = true,
    Callback = function(Value)
        local num = tonumber(Value)
        if num then
            game.Workspace.Gravity = num
        end
    end
})

-- 视觉增强：夜视
Tab:AddToggle({
    Name = "夜视",
    Default = false,
    Callback = function(Value)
        game.Lighting.Ambient = Value and Color3.new(1, 1, 1) or Color3.new(0, 0, 0)
    end
})

-- 视觉增强：飞行（依赖远程脚本）
Tab:AddToggle({
    Name = "飞行",
    Default = false,
    Callback = function(Value)
        if Value then
            loadRemoteScript(
                "https://raw.githubusercontent.com/HXB20111/roblox-/refs/heads/main/%E9%BB%84%E9%A3%9E%E8%A1%8C",
                "飞行功能已启用",
                "飞行功能加载失败"
            )
        end
    end
})

-- 物理操控：穿墙（完整校验）
local isClipping = false
local stepConnection
Tab:AddToggle({
    Name = "穿墙",
    Default = false,
    Callback = function(enabled)
        isClipping = enabled
        local localPlayer = game.Players.LocalPlayer
        local char = localPlayer.Character
        
        if not char then 
            OrionLib:MakeNotification({
                Name = "错误",
                Content = "角色未加载，无法开启穿墙",
                Time = 2
            })
            return 
        end

        if enabled then
            stepConnection = game:GetService("RunService").Stepped:Connect(function()
                if isClipping and char then
                    for _, part in pairs(char:GetDescendants()) do
                        if part:IsA("BasePart") then
                            part.CanCollide = false
                        end
                    end
                else
                    stepConnection:Disconnect()
                end
            end)
            OrionLib:MakeNotification({Name = "状态", Content = "穿墙已开启", Time = 2})
        else
            for _, part in pairs(char:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = true
                end
            end
            OrionLib:MakeNotification({Name = "状态", Content = "穿墙已关闭", Time = 2})
            if stepConnection then stepConnection:Disconnect() end
        end
    end,
    Color = Color3.fromRGB(100, 149, 237)
})

-- 旋转控制：旋转速度
Tab:AddTextbox({
    Name = "旋转速度",
    Placeholder = "数值范围: 1-1000",
    Callback = function(Value)
        local speed = tonumber(Value)
        if not speed or speed < 1 or speed > 1000 then
            OrionLib:MakeNotification({
                Name = "错误",
                Content = "请输入1-1000之间的数字",
                Time = 2
            })
            return
        end

        local localPlayer = game.Players.LocalPlayer
        local char = localPlayer.Character
        if not char then return end

        local humRoot = char:WaitForChild("HumanoidRootPart")
        local humanoid = char:WaitForChild("Humanoid")
        humanoid.AutoRotate = false

        local spinVelocity = humRoot:FindFirstChild("Spinbot")
        if not spinVelocity then
            spinVelocity = Instance.new("AngularVelocity")
            spinVelocity.Attachment0 = humRoot:WaitForChild("RootAttachment")
            spinVelocity.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
            spinVelocity.AngularVelocity = Vector3.new(0, speed, 0)
            spinVelocity.Name = "Spinbot"
            spinVelocity.Parent = humRoot
        else
            spinVelocity.AngularVelocity = Vector3.new(0, speed, 0)
        end

        OrionLib:MakeNotification({
            Name = "设置成功",
            Content = string.format("旋转速度: %d°/s", speed),
            Time = 2
        })
    end
})

-- 旋转控制：停止旋转
Tab:AddButton({
    Name = "停止旋转",
    Callback = function()
        local localPlayer = game.Players.LocalPlayer
        local char = localPlayer.Character
        if not char then return end

        local humRoot = char:WaitForChild("HumanoidRootPart")
        local humanoid = char:WaitForChild("Humanoid")
        
        local spinbot = humRoot:FindFirstChild("Spinbot")
        if spinbot then
            spinbot:Destroy()
            humanoid.AutoRotate = true
            OrionLib:MakeNotification({
                Name = "状态",
                Content = "旋转已停止",
                Time = 1.5
            })
        else
            OrionLib:MakeNotification({
                Name = "提示",
                Content = "未检测到旋转",
                Time = 1.5
            })
        end
    end,
    Color = Color3.fromRGB(255, 99, 71)
})

-- 特殊功能：踏空（依赖远程脚本）
Tab:AddToggle({
    Name = "踏空",
    Default = false,
    Callback = function(Value)
        if Value then
            loadRemoteScript(
                "https://raw.githubusercontent.com/GhostPlayer352/Test4/main/Float",
                "踏空功能已启用",
                "踏空功能加载失败"
            )
        end
    end
})

-- 特殊功能：自瞄（依赖远程脚本）
Tab:AddButton({
    Name = "自瞄",
    Callback = function()
        loadRemoteScript(
            "https://raw.githubusercontent.com/AZYsGithub/chillz-workshop/main/Arceus%20Aimbot.lua",
            "自瞄功能已加载",
            "自瞄功能加载失败"
        )
    end
})

-- 透视功能（完整校验）
Tab:AddButton({
    Name = "透视",
    Callback = function()
        local Players = game:GetService("Players")
        local Teams = game:GetService("Teams")
        local LP = Players.LocalPlayer

        local function IsEnemy(plr)
            if not plr.Team or not LP.Team then return false end
            return plr.Team ~= LP.Team
        end

        local function CreateHighlight(target, color)
            local h = Instance.new("Highlight")
            h.Name = "StyledHighlight"
            h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
            h.FillColor = color
            h.FillTransparency = 0.7
            h.OutlineColor = color
            h.OutlineTransparency = 0.3
            h.Adornee = target
            h.Parent = target
        end

        local function SetupVisuals(plr)
            if plr == LP or not plr.Character then return end
            local char = plr.Character
            if char:FindFirstChild("StyledHighlight") then return end

            local color = IsEnemy(plr) and Color3.new(1, 0, 0) or Color3.new(0, 1, 1)
            CreateHighlight(char, color)
        end

        -- 初始化已存在的玩家
        for _, plr in ipairs(Players:GetPlayers()) do
            SetupVisuals(plr)
        end

        -- 处理新加入的玩家
        Players.PlayerAdded:Connect(function(plr)
            plr.CharacterAdded:Connect(function()
                task.wait(0.2)
                SetupVisuals(plr)
            end)
        end)

        -- 移除自身高亮
        LP.CharacterAdded:Connect(function(char)
            local h = char:FindFirstChild("StyledHighlight")
            if h then h:Destroy() end
        end)
    end
})

-- 关闭透视
Tab:AddButton({
    Name = "关闭透视",
    Callback = function()
        for _, plr in pairs(game:GetService("Players"):GetPlayers()) do
            if plr.Character then
                local h = plr.Character:FindFirstChild("StyledHighlight")
                if h then h:Destroy() end
            end
        end
    end
})

-- ================ 作者信息 Tab ================
local AuthorTab = Window:MakeTab({
    Name = "作者信息",
    Icon = "rbxassetid://4483345998"
})

AuthorTab:AddParagraph("作者", "Hfh916")
AuthorTab:AddParagraph("作者QQ", "135737738")
AuthorTab:AddParagraph("QQ群", "110")

-- 复制作者QQ（区分环境）
AuthorTab:AddButton({
    Name = "复制作者QQ",
    Callback = function()
        if type(setclipboard) == "function" then
            setclipboard("1357377308")
            OrionLib:MakeNotification({Name = "成功", Content = "已复制作者QQ", Time = 2})
        else
            OrionLib:MakeNotification({
                Name = "提示",
                Content = "当前环境不支持自动复制，请手动复制：1357377308",
                Time = 5
            })
        end
    end,
    Color = Color3.fromRGB(70, 130, 255)
})

-- 复制QQ群（区分环境）
AuthorTab:AddButton({


AuthorTab:AddButton({
    Name = "复制QQ群",
    Callback = function()
        if setclipboard then
            setclipboard("110")
            OrionLib:MakeNotification({Name = "成功", Content = "已复制QQ群", Time = 2})
        end
    end,
    Color = Color3.fromRGB(100, 200, 100)
})

-- 开发者工具
local InkGameTab = Window:MakeTab({
    Name = "开发者",
    Icon = "rbxassetid://4483345998",
    PremiumOnly = false
})

InkGameTab:AddButton({
    Name = "Dex",
    Callback = function()
        loadRemoteScript("https://raw.githubusercontent.com/Focuslol666/RbxScripts/refs/heads/main/Other/DexPlusPlus%20(ZH-CN).lua",
                        "Dex加载成功",
                        "Dex加载失败")
    end
})

InkGameTab:AddButton({
    Name = "IY",
    Callback = function()
        loadRemoteScript('https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source',
                        "IY加载成功",
                        "IY加载失败")
    end
})

-- 其他脚本加载中心
local ScriptCenterTab = Window:MakeTab({
    Name = "脚本中心",
    Icon = "rbxassetid://4483345998"
})

-- 通用脚本加载模板
local function addScriptButton(tab, name, url, successMsg, failMsg, color)
    tab:AddButton({
        Name = name,
        Callback = function()
            loadRemoteScript(url, successMsg, failMsg)
        end,
        Color = color
    })
end

addScriptButton(ScriptCenterTab,
    "加载皮脚本",
    "https://raw.githubusercontent.com/xiaopi77/xiaopi77/main/QQ1002100032-Roblox-Pi-script.lua",
    "皮脚本加载成功",
    "皮脚本加载失败",
    Color3.fromRGB(123, 104, 238)
)

addScriptButton(ScriptCenterTab,
    "安脚本",
    'https://raw.githubusercontent.com/wucan114514/gegeyxjb/refs/heads/main/%E5%AE%89%E8%84%9A%E6%9C%AC.lua',
    "安脚本加载成功",
    "安脚本加载失败",
    Color3.fromRGB(255, 99, 71)
)

addScriptButton(ScriptCenterTab,
    "落叶脚本",
    "https://raw.githubusercontent.com/krlpl/Deciduous-center-LS/main/%E8%90%BD%E5%8F%B6%E4%B8%AD%E5%BF%83%E6%B7%B7%E6%B7%86.txt",
    "落叶脚本加载成功",
    "落叶脚本加载失败",
    Color3.fromRGB(139, 69, 19)
)

addScriptButton(ScriptCenterTab,
    "霖溺脚本",
    "https://raw.githubusercontent.com/ShenJiaoBen/ScriptLoader/refs/heads/main/Linni_FreeLoader.lua",
    "霖溺加载成功",
    "霖溺加载失败",
    Color3.fromRGB(70, 200, 200)
)

addScriptButton(ScriptCenterTab,
    "叶脚本",
    "https://raw.githubusercontent.com/roblox-ye/QQ515966991/refs/heads/main/ROBLOX-CNVIP-XIAOYE.lua",
    "叶脚本加载成功",
    "叶脚本加载失败",
    Color3.fromRGB(123, 200, 91)
)

addScriptButton(ScriptCenterTab,
    "刹脚本",
    "https://raw.githubusercontent.com/FengYu-3/FengYu/refs/heads/main/shascript.lua",
    "刹脚本加载成功",
    "刹脚本加载失败",
    Color3.fromRGB(200, 70, 70)
)

addScriptButton(ScriptCenterTab,
    "泷脚本",
    "https://raw.githubusercontent.com/2012long/long/refs/heads/main/%E6%B3%B7%E6%AD%BB%E9%93%81.lua",
    "泷脚本加载成功",
    "泷脚本加载失败",
    Color3.fromRGB(105, 105, 105)
)

addScriptButton(ScriptCenterTab,
    "汉化脚本",
    'https://raw.githubusercontent.com/S-WTB/-/refs/heads/main/ISIS加载器',
    "汉化脚本加载成功",
    "汉化脚本加载失败",
    Color3.fromRGB(255, 78, 91)
)

addScriptButton(ScriptCenterTab,
    "RB脚本",
    "https://raw.githubusercontent.com/Yungengxin/roblox/refs/heads/main/Rb-Hub",
    "RB脚本加载成功",
    "RB脚本加载失败",
    Color3.fromRGB(245, 70, 90)
)

addScriptButton(ScriptCenterTab,
    "TX脚本",
    "https://raw.githubusercontent.com/JsYb666/TX-Free-YYDS/refs/heads/main/FREE-TX-TEAM",
    "TX脚本加载成功",
    "TX脚本加载失败",
    Color3.fromRGB(255, 91, 78)
)

-- 初始化界面
OrionLib:Init()
