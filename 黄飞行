-- 加载Fluent UI库及附加组件
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- 创建主窗口
local Window = Fluent:CreateWindow({
    Title = "黄飞行辅助",
    SubTitle = "作者：Hfh916",
    TabWidth = 160,
    Size = UDim2.fromOffset(500, 400),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

-- 创建标签页
local Tabs = {
    飞行控制 = Window:AddTab({ Title = "飞行控制", Icon = "" }),
    设置 = Window:AddTab({ Title = "设置", Icon = "settings" })
}

-- 全局变量
local speeds = 1
local nowe = false
local tpwalking = false
local speaker = game:GetService("Players").LocalPlayer

-- 显示通知
Fluent:Notify({
    Title = "黄脚本用户 专属",
    Content = "脚本作者：Hfh916",
    Duration = 5
})

-- 飞行控制标签页内容
do
    -- 飞行开关
    local FlyToggle = Tabs.飞行控制:AddToggle("FlyToggle", {
        Title = "飞行模式",
        Description = "开启/关闭飞行功能",
        Default = false
    })

    FlyToggle:OnChanged(function(Value)
        nowe = Value
        local chr = speaker.Character
        local hum = chr and chr:FindFirstChildWhichIsA("Humanoid")
        if not chr or not hum then return end

        if nowe then
            -- 开启飞行
            game.Players.LocalPlayer.Character.Animate.Disabled = true
            local Hum = chr:FindFirstChildOfClass("Humanoid") or chr:FindFirstChildOfClass("AnimationController")
            for _, v in next, Hum:GetPlayingAnimationTracks() do
                v:AdjustSpeed(0)
            end

            -- 禁用人类oid状态
            for _, state in ipairs(Enum.HumanoidStateType:GetEnumItems()) do
                hum:SetStateEnabled(state, false)
            end
            hum:ChangeState(Enum.HumanoidStateType.Swimming)

            -- 启动多线程移动加速
            tpwalking = false
            for i = 1, speeds do
                spawn(function()
                    local hb = game:GetService("RunService").Heartbeat
                    tpwalking = true
                    while tpwalking and hb:Wait() and chr and hum and hum.Parent do
                        if hum.MoveDirection.Magnitude > 0 then
                            chr:TranslateBy(hum.MoveDirection)
                        end
                    end
                end)
            end

            -- 根据角色类型设置飞行物理
            local rootPart = chr:FindFirstChild("Torso") or chr:FindFirstChild("UpperTorso")
            if rootPart then
                local bg = Instance.new("BodyGyro", rootPart)
                bg.P = 9e4
                bg.maxTorque = Vector3.new(9e9, 9e9, 9e9)
                bg.cframe = rootPart.CFrame

                local bv = Instance.new("BodyVelocity", rootPart)
                bv.velocity = Vector3.new(0, 0.1, 0)
                bv.maxForce = Vector3.new(9e9, 9e9, 9e9)
                hum.PlatformStand = true

                -- 飞行控制循环
                spawn(function()
                    local ctrl = { f = 0, b = 0, l = 0, r = 0 }
                    local lastctrl = { f = 0, b = 0, l = 0, r = 0 }
                    local maxspeed = 50
                    local speed = 0

                    while nowe and chr and hum and hum.Health > 0 do
                        game:GetService("RunService").RenderStepped:Wait()
                        
                        -- 速度控制
                        if ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0 then
                            speed = speed + 0.5 + (speed / maxspeed)
                            if speed > maxspeed then speed = maxspeed end
                        elseif speed ~= 0 then
                            speed = speed - 1
                            if speed < 0 then speed = 0 end
                        end

                        -- 移动控制
                        if (ctrl.l + ctrl.r) ~= 0 or (ctrl.f + ctrl.b) ~= 0 then
                            bv.velocity = ((workspace.CurrentCamera.CFrame.lookVector * (ctrl.f + ctrl.b)) + 
                                ((workspace.CurrentCamera.CFrame * CFrame.new(ctrl.l + ctrl.r, (ctrl.f + ctrl.b) * 0.2, 0).p) - 
                                workspace.CurrentCamera.CFrame.p)) * speed
                            lastctrl = { f = ctrl.f, b = ctrl.b, l = ctrl.l, r = ctrl.r }
                        elseif speed ~= 0 then
                            bv.velocity = ((workspace.CurrentCamera.CFrame.lookVector * (lastctrl.f + lastctrl.b)) + 
                                ((workspace.CurrentCamera.CFrame * CFrame.new(lastctrl.l + lastctrl.r, (lastctrl.f + lastctrl.b) * 0.2, 0).p) - 
                                workspace.CurrentCamera.CFrame.p)) * speed
                        else
                            bv.velocity = Vector3.new(0, 0, 0)
                        end

                        bg.cframe = workspace.CurrentCamera.CFrame * CFrame.Angles(-math.rad((ctrl.f + ctrl.b) * 50 * speed / maxspeed), 0, 0)
                    end

                    -- 清理
                    bg:Destroy()
                    bv:Destroy()
                    hum.PlatformStand = false
                    chr.Animate.Disabled = false
                    tpwalking = false
                end)
            end
        else
            -- 关闭飞行
            tpwalking = false
            game.Players.LocalPlayer.Character.Animate.Disabled = false
            for _, state in ipairs(Enum.HumanoidStateType:GetEnumItems()) do
                hum:SetStateEnabled(state, true)
            end
            hum:ChangeState(Enum.HumanoidStateType.RunningNoPhysics)
        end
    end)

    -- 速度调节滑块
    local SpeedSlider = Tabs.飞行控制:AddSlider("SpeedSlider", {
        Title = "飞行速度",
        Description = "调节飞行速度倍率",
        Default = 1,
        Min = 1,
        Max = 10,
        Rounding = 1
    })

    SpeedSlider:OnChanged(function(Value)
        speeds = Value
        if nowe then
            tpwalking = false
            for i = 1, speeds do
                spawn(function()
                    local hb = game:GetService("RunService").Heartbeat
                    tpwalking = true
                    local chr = speaker.Character
                    local hum = chr and chr:FindFirstChildWhichIsA("Humanoid")
                    while tpwalking and hb:Wait() and chr and hum and hum.Parent do
                        if hum.MoveDirection.Magnitude > 0 then
                            chr:TranslateBy(hum.MoveDirection)
                        end
                    end
                end)
            end
        end
    end)

    -- 上下移动按钮
    Tabs.飞行控制:AddButton({
        Title = "向上移动",
        Description = "点击并保持以向上移动",
        Callback = function()
            local chr = speaker.Character
            local root = chr and chr:FindFirstChild("HumanoidRootPart")
            if not root then return end
            
            local connection
            connection = game:GetService("RunService").Heartbeat:Connect(function()
                root.CFrame = root.CFrame * CFrame.new(0, 1, 0)
            end)
            
            -- 等待鼠标释放
            local mouse = game.Players.LocalPlayer:GetMouse()
            mouse.Button1Up:Wait()
            connection:Disconnect()
        end
    })

    Tabs.飞行控制:AddButton({
        Title = "向下移动",
        Description = "点击并保持以向下移动",
        Callback = function()
            local chr = speaker.Character
            local root = chr and chr:FindFirstChild("HumanoidRootPart")
            if not root then return end
            
            local connection
            connection = game:GetService("RunService").Heartbeat:Connect(function()
                root.CFrame = root.CFrame * CFrame.new(0, -1, 0)
            end)
            
            -- 等待鼠标释放
            local mouse = game.Players.LocalPlayer:GetMouse()
            mouse.Button1Up:Wait()
            connection:Disconnect()
        end
    })
end

-- 角色重生处理
game:GetService("Players").LocalPlayer.CharacterAdded:Connect(function(char)
    task.wait(0.7)
    local hum = char:FindFirstChildOfClass("Humanoid")
    if hum then
        hum.PlatformStand = false
    end
    local animate = char:FindFirstChild("Animate")
    if animate then
        animate.Disabled = false
    end
end)

-- 设置标签页
do
    -- 界面管理
    InterfaceManager:BuildInterfaceSection(Tabs.设置)
    
    -- 配置保存
    SaveManager:SetLibrary(Fluent)
    SaveManager:IgnoreThemeSettings()
    SaveManager:SetFolder("黄飞行辅助")
    SaveManager:BuildConfigSection(Tabs.设置)
end

-- 选择初始标签页
Window:SelectTab(1)

-- 加载自动配置
SaveManager:LoadAutoloadConfig()
